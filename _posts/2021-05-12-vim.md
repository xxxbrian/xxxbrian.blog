---
layout:     post
title:      "Vim 8文本处理实战"
subtitle:   "Hands-on Text Processing with Vim 8."
date:       2021-05-19 14:26:31
author:     "xxxbrian"
catalog: true
header-img: "img/in-post/2021-05-12-vim/bg-vim.jpeg"
header-mask: 0.4
tags:
  - 笔记
  - 教程
  - Vim
  - 转载
---

本文介绍了各种常用的文本编辑方法和程序设计中的实用操作，深入Vim内部的数据结构和VimScript脚本编程，内容详实。本文基于Vim 8平台，介绍了前沿分支Neovim，还推荐了更先进的Oni编辑器，兼容并包，集Vim社区典型使用经验和发展趋势于一体。

本文面向的读者群体是所有使用Vim的程序员，书中的示例文本为Python代码，并详细介绍了Git和正则表达式。读者需要对操作系统和程序设计有基本的了解，特别是需要了解Linux操作系统的基本使用。虽然本文尝试兼顾三大操作系统，但毫无疑问书中内容以Linux为主。本文可以帮助读者完善Vim技能，增加程序设计的知识储备。

## 关于作者

Ruslan Osipov 是 Google 公司的软件工程师，也是一名旅游爱好者和业余博主。他自学成才，2012 年开始发布个人的 Vim 笔记。从那时开始，Ruslan 就越来越关注这款强大的编辑器，以及那些可优化工作流程的应用。

## 本文的读者

本文适用于初级、中级和高级程序员。本文将介绍如何高效地将 Vim 应用于日常工作流程的方方面面。虽然书中涉及了 Python，但 Python 或 Vim 的经验并不是阅读本文所必需的

## 本文的内容提要

- 第 1 章，开始 Vim 之旅。介绍了 Vim 的基本概念。
- 第 2 章，高级编辑和文本浏览。介绍了光标移动方法和更复杂的编辑操作，另外，还介绍了几种插件。
- 第 3 章，使用先导键——插件管理。介绍了模式、键盘映射和插件管理。
- 第 4 章，理解文本。介绍如何基于语义地使用代码库，并在代码库中浏览文件。
- 第 5 章，构建、测试和执行。介绍如何在编辑器内外运行代码。
- 第 6 章，用正则表达式和宏来重构代码。深入介绍代码重构操作。
- 第 7 章，定制自己的 Vim。讨论了如何进一步定制个人的 Vim 工作流程。
- 第 8 章，卓尔不凡的 Vimscript。深入介绍了 Vim 提供的强大脚本语言。
- 第 9 章，Neovim。推介了一种新的 Vim 变体。
- 第 10 章，延伸阅读。本章为读者提供了一些建议以供参考，并推荐了一些读者可能会感兴趣的资源站点。

## 配套资源

本文源代码: [B11044_Code.zip](https://github.com/xxxbrian/xxxbrian.blog/blob/master/img/in-post/2021-05-12-vim/book-res/B11044_Code.zip?raw=true)

# 第 1 章　开始 Vim 之旅

本文将向读者介绍如何更好地使用 Vim 和 Vim 插件，以及一些与 Vim 理念一脉相承的工具。

每个工具背后都有它的独特理念，Vim 也不例外。Vim 引入了一种不同的文本处理方式，这种方式是现如今大部分人并不熟悉的。

本章的内容是为使用 Vim 作铺垫，重点介绍这种理念的与众不同之处，并向读者推荐一些良好的编辑习惯，帮助读者体验一个操作更友好的 Vim，并确保读者能够在工作中找到适合自己的工具。为了让示例更加具体，本章会使用 Vim 来创建一个短小的 Python 程序。

本章会涉及如下主题。

- 模式界面和无模式界面的对比，为什么 Vim 与众不同。
- Vim 的安装和基本编辑功能。
- Vim 的图形用户界面 gVim。
- 通过配置 Vim 来编写 Python，修改配置文件`.vimrc`。
- 常用文件操作，包括打开、修改、保存和关闭文件。
- 光标移动操作，包括通过箭头键移动、`hjkl`键、逐个单词移动、逐段落移动等。
- 文件的简单编辑，将编辑命令与光标移动命令结合起来。
- 持久化的撤销历史。
- 浏览 Vim 的内置手册。

## 1.1 　技术性要求

本章示例是一些基本的 Python 程序，读者没必要专门去下载与本章相关的任何代码，因为这些代码都可以从头开始编写。如果读者没有跟上节奏而需要更多指引，可以在异步社区中找到示例代码。

本文用 Vim 编写 Python 代码，并且假定读者对该语言比较熟悉，版本为 Python 3。

如果读者习惯 Python 2 的语法，则只需要修改`print()`命令，就可以将 Python 3 示例转换为 Python 2 了。比如，将所有的`print('Woof!')`换成`print 'Woof!'`，代码就可以作为 Python 2 版本正常运行了。

本章还会介绍如何创建和修改 Vim 配置文件，即`.vimrc`文件。最终的`.vimrc`文件可以在异步社区中找到。

## 1.2 　开始对话（关于模式界面）

如果读者曾经编辑过文本，很可能已经非常熟悉无模式（modeless）界面了，因为这是现代主流文本编辑器的默认选项，大多数人也是通过它来学习文本处理的。“无模式”指的是每个界面元素都只有一个功能，每个按钮都对应于屏幕上的一个字母或某种其他操作，每个按键（或组合键）总是做同样的事：此应用程序总是以单一模式来执行操作。

但这并不是文本处理的唯一方式。那么现在，欢迎来到模式界面的世界。在这里，根据上下文的不同，每个行为可能对应于不同的操作。现在常见的模式界面应用设备为智能手机，每当打开一个不同的应用或菜单时，在屏幕上单击一下就会执行不同的功能。

对于文本编辑器，情况类似。Vim 就是一款模式编辑器，即在不同的上下文，单击一个按钮会产生不同的行为结果。当 Vim 处于插入模式（用于文本输入的模式）时，单击 `o` 键会在屏幕上得到 `o` 。但当切换到不同的模式时，按 `o` 键的行为会发生变化，比如在光标下面添加新行。

使用 Vim 就像是与编辑器进行对话。通过命令 `d3w\[` 刚好是删除（delete）3 个单词（word）的英文缩写， `]` 可以删除后面 3 个词；通过命令 `ci"[` 改变（change）引号里面（inside）的英文缩写\]则可以改变引号里面的文本。

编辑速度快并不是 Vim 的卖点。Vim 让用户置身于文本处理的流程中，不需要因为找鼠标而打乱节奏；也不需要按 17 次方向键到达页面中的某个位置；更不需要在复制粘贴时通过鼠标操作来小心翼翼地选择文本。

当使用无模式编辑器时，工作流程总是会被打断。而对于模式编辑器，特别是 Vim，文本处理就像是与编辑器进行了一次亲密交谈，而且是用一种一致的语言与编辑器进行交流，比如删除 3 个单词（命令为 `d3w` ）、改变引号内文本（命令为 `ci"` ）。通过 Vim，文本编辑变成一种更从容的操作。

## 1.3 　安装

Vim 可在各种操作系统中安装，而且在 Linux 和 macOS 中是自带的（不过，读者可能需要将其升级到更新的版本）。在接下来的章节中，请读者确认自己的操作系统，并根据指令设置好 Vim。

### 1.3.1 　在 Linux 系统中设置 Vim

Linux 操作系统自带 Vim，但是其版本可能比较旧了，而本文使用的 Vim 8 引入了一些急需的优化。首先，读者需要进入命令行界面，然后执行如下命令。

    $ git clone https://github.com/vim/vim.git
    $ cd vim/src
    $ make
    $ sudo make install

如果读者在安装 Vim 时遇到问题，原因可能是系统中缺少一些依赖库。如果读者使用的是基于 Debian 的 Linux 发行版，下列命令可以用于安装常用的缺失依赖库。
>
>     $ sudo apt-get install make build-essential libncurses5-dev
>
>       libncursesw5-dev --fix-missing

注意，这里的 `$` 仅仅用来标识这是一个 Shell 命令，并不属于命令行的一部分。按照上述方法，可以成功将 Vim 更新到最新版本。当然，如果读者不在乎是否最新，仍然可以使用系统的包管理器来更新 Vim。不同的 Linux 发行版本使用不同的包管理器，如下表所示。

|             发　行　版              |        安装最新 Vim 的命令        |
| :---------------------------------: | :-------------------------------: |
| 基于 Debian（Debian、Ubuntu、Mint） |      `$ sudo apt-get update`      |
|                                     | `$ sudo apt-get install vim-gtk`  |
| CentOS（以及 Fedora 22 之前的版本） |     `$ sudo yum check-update`     |
|                                     | `$ sudo yum install vim-enhanced` |
|             Fedora 22+              |     `$ sudo dnf check-update`     |
|                                     | `$ sudo dnf install vim-enhanced` |
|                Arch                 |       `$ sudo pacman -Syu`        |
|                                     |      `$ sudo pacman -S gvim`      |
|               FreeBSD               |        `$ sudo pkg update`        |
|                                     |     `$ sudo pkg install vim`      |

在上表中可以发现，Vim 在不同的软件库中使用不同的名称。基于 Debian 的发行版中的 `vim-gtk` ，或 CentOS 上的 `vim-enhanced` 提供了更多的功能（如图形用户界面支持）。

有一点需要注意的是，包管理器软件仓库中的 Vim 版本一般会有所滞后，少则几个月，多则几年。

现在已经准备好进入 Vim 世界了！可以通过如下命令打开一个 Vim 编辑器。

    $ vim

在现代的操作系统上，读者可以通过命令 `vi` 打开 Vim，但这不是绝对的。在旧版本的系统上，两者是不同的程序。Vim 是 Vi 的继承者（Vim 是 Vi improved 的缩写），只不过，现如今 Vi 仅仅是指向 Vim 的一个别名。而且，我们没有理由使用 Vi 而不使用 Vim，除非由于某种原因无法安装 Vim。

### 1.3.2 　在 macOS 系统中设置 Vim

macOS 系统中已经安装好了 Vim，但是版本较旧。安装更新版本的 Vim 有很多种方法，这里介绍两种。第一种方法是使用 Homebrew 安装，这是 macOS 上的一种包管理器。不过，读者需要首先安装 Homebrew。第二种方法是下载 MacVim 的`.dmg`安装包，对于习惯了图形界面的 Mac 用户而言，这种安装体验会更熟悉一些。

因为本文使用命令行进行交互，所以推荐使用 Homebrew 安装 Vim。但是如果读者对命令行实在不感兴趣，则可以使用`.dmg`安装包完成 Vim 的安装。

#### 1．使用 Homebrew

Homebrew 是 macOS 上的一种第三方包管理器，它可以使用户方便地安装或更新到最新的软件。关于如何安装 Homebrew，读者可以在 Homebrew 官网中找到相关指令。编写本文的时候，Homebrew 的安装命令已经简化为一条命令行。

    $ /usr/bin/ruby -e "$(curl –fsSL
    https://raw.githubusercontent.com/Homebrew/install/master/install)"

下图为该命令执行 Homebrew 安装过程所需要经历的一系列操作。执行操作后按`Enter`键。

![](/img/in-post/2021-05-12-vim/7dd733598ebbc8a1.png)

> 如果读者没有安装 Xcode（Xcode 通常是在 macOS 上进行与开发相关的行为的必备条件），则会得到一个 Xcode 的安装提示框。这里不会直接使用 Xcode，因而按照默认设置安装好就可以了。

这个过程可能会有点长，但如果一切顺利，最终会安装好 Homebrew。Homebrew 是一个神奇的工具，它的功能不仅仅是安装 Vim！安装完成时，会看到粗体字显示的**安装成功!**提示。

用下面的命令安装新版本的 Vim。

    $ brew install vim

Homebrew 会安装好所有必要的依赖项，正常情况下，读者会看到如下图所示的结果。

![](/img/in-post/2021-05-12-vim/bd34219b814f0d5d.png)

如果读者已经安装了 Homebrew，而且曾经安装过 Vim，则前面的命令将会产生一个错误。如果读者只是想更新到最新版本的 Vim，这时应该执行下列命令。

    $ brew upgrade vim

现在，已经准备好使用 Vim 了，那么用下面的命令开启 Vim 之旅吧。

    $ vim

下图所示为 Vim 的启动界面。

![](/img/in-post/2021-05-12-vim/ad2eae5bc663b1b5.png)

#### 2．下载.dmg 安装包

首先，下载`MacVim.dmg`。然后双击打开`MacVim.dmg`，再将 Vim 图标拖曳到`Applications`目录中，如下图所示。

![](/img/in-post/2021-05-12-vim/b936a4d7a9d87565.png)

由于 Mac 的安全设置，因此当读者进入`Applications`目录并尝试打开`MacVim`应用时，系统可能会弹出下图中的错误提示。

![](/img/in-post/2021-05-12-vim/0be2ea0b0403da13.png)

为解决这个问题，可以打开`Applications`目录，找到`MacVim`，右键单击图标，选择**Open**选项，系统会弹出如下图所示的对话框。

![](/img/in-post/2021-05-12-vim/a2555827212103a9.png)

单击**Open**按钮，`MacVim`会正常启动，而且以后都不会再弹出这样的对话框。下图所示为 Vim 的启动界面。

![](/img/in-post/2021-05-12-vim/029209ef17587a74.png)

### 1.3.3 　在 Windows 系统中设置 Vim

在 Windows 操作系统下有两种安装 Vim 的方式：第一种是在 Cygwin 中安装命令行版本的 Vim，并在命令行中使用 Vim；第二种是安装 Vim 的图形界面版本 gVim（它也有在`cmd.exe`上运行的终端版本）。建议读者尝试两种安装方式并从中选择喜欢的一种：gVim 更像 Windows 系统中的其他应用程序（也更容易安装），而 Cygwin 可能对于习惯了 UNIX Shell 命令行的人来说更亲切一些。

#### 在 Cygwin 中感受类 UNIX 操作体验

Cygwin 是 Windows 的类 UNIX 环境，它提供了一种命令行界面，致力于将强大的 UNIX Shell 命令行以及相关的支撑工具带到 Windows 操作系统中。

（1）安装 Cygwin

在开始安装之前，需要先浏览 Cygwin 官网 ，然后下载`setup-x86_64.exe`或`setup-x86.exe`，它们分别对应于 64 位和 32 位的版本。

> 如果不确定操作系统是 32 位还是 64 位，可以打开“**控制面板->系统和安全->系统**”，找到“**系统类型**”。比如，很多 64 位的 Windows 机器上会显示**系统类型：64 位操作系统，基于 x64 的处理器**。

双击下载的可执行文件，会弹出如下图所示的 Cygwin 安装窗口。

![](/img/in-post/2021-05-12-vim/97284d6055052e5a.png)

在接下来的安装工程中，单击**Next**按钮数次，即以此选择如下默认设置。

- 下载源（Download source）：从互联网地址下载，而不是本地缓存。
- 根目录（Root directory）：`C:\cygwin 64`（或其他推荐的默认设置）。
- 为哪些用户安装（Install for）：所有用户。
- 本地软件包目录（Local package directory）：`C:\Downloads`（或其他推荐默认设置）。
- 网络连接（Internet connection）：使用系统代理设置。
- 下载站点（Download site）：`http://cygwin.mirror.constant.com` （或任意其他可用选项）。

在完成这些步骤之后，会看到选择软件包的界面。这里，本文将选择`vim`、`gvim`和`vim-doc`软件包。较容易的方法是在搜索框中输入`vim`，展开**All|Editors**类别，然后单击相应的软件包旁边的图标，如下图所示。

![](/img/in-post/2021-05-12-vim/efbac38fe6f9f292.png)

上图显示 Vim 版本为 8.0.1567-1。编写本文时，也就是 2018 年 11 月，这是 Cygwin 中唯一可用的版本。与 8.1 版本相比，8.0 版本主要缺少了`:terminal`命令（见第 5 章）。

> 读者可能还需要安装 Net 类别中的`curl`，以及 Devel 类别中的`git`，因为在第 3 章中会用到这两个工具。另外，安装 Utils 类别中的`dos2unix`也大有好处，此工具可将文本中 Windows 样式的换行符转换成 Linux 样式的换行符（使用 Vim 通常会遇到这个问题）。

然后，单击两次**Next**按钮，正式开始这些软件包的安装过程。安装过程会持续一段时间。

有时候，安装过程中会产生一些 post-install 脚本错误，大部分情况下可以安全地忽略（除非其中包含 Vim 相关的错误—— 这时可能就需要参考 Google 的意见：搜索错误消息中的文本，然后尝试找到解决方案）。

再接着单击**Next**按钮数次，即默认选择如下选项。

- 在桌面上创建图标。
- 在开始菜单中添加图标。

现在已经成功安装了 Cygwin 和 Cygwin 中的 Vim。

> 如果读者还需要在 Cygwin 中安装其他软件包，则只需要再次打开安装包可执行文件，然后选择需要的软件包。

（2）使用 Cygwin

Cygwin 的应用程序可能叫作**Cygwin64 Terminal**或**Cygwin Termianl**，这取决于操作系统的类型。找到其图标，如下图所示。

![](/img/in-post/2021-05-12-vim/0d0c563d7ceaf288.png)

打开它，可以看到如下图所示的命令行提示界面，Linux 用户应该相当熟悉了。

![](/img/in-post/2021-05-12-vim/bff44f6d4a37a6ba.png)

Cygwin 支持本文中用到的所有 UNIX 样式的 Shell 命令行。如果部分命令行需要修改才能用于 Cygwin，本文也会特别说明。但是目前，只需要简单地打开 Vim 使用即可，直到第 2 章都不会有任何问题。在命令行提示符中输入`vim`，按`Enter`键启动 Vim，界面如下图所示。

![](/img/in-post/2021-05-12-vim/9eba7afcecc07589.png)

Cygwin 是在 Windows 环境下体验 Linux 系统 Shell 命令的一种方式，这意味着，一旦在阅读本文时选择使用 Cygwin，就需要遵循 Linux 系统中的指令和约定。同时，还需要注意 Windows 样式的换行符和 Linux 样式的换行符，因为 Windows 和 Linux 处理换行的方式不同。如果在 Vim 中遇到`^M`字符无法识别，则对相应的文件执行`dos2unix`命令就可以解决。

### 1.3.4 　可视化的 Vim：gVim

通过对比命令行 Vim 和 gVim，本节将详细介绍 Vim 的图形化版本 gVim。

与 Windows 系统中其他程序的安装过程相比，gVim 的安装过程要更图形化一些。在浏览器中打开`Vim`网站，下载一个可执行的安装包。编写本文时（2018 年 11 月），这个二进制文件名为`gvim81.exe`，其中的`81`代表版本 8.1。打开这个可执行文件，会弹出如下图所示的提示框。

![](/img/in-post/2021-05-12-vim/46bf6c4bcc51611d.png)

单击**Yes**按钮，然后单击**I Agree**按钮，直到出现**Installation Options**界面。大部分默认设置是满足本文需求的，如果需要在命令行中使用 Vim，可以通过启用**Create .bat files for command line use**选项来实现。这个选项让读者可以在 Windows 命令提示符中使用`vim`。本文中的一些例子需要用到命令提示符，因此启用这个选项对于接下来的阅读是有帮助的。

下图所示为**Installation Options**界面的截屏，注意，图中已经启用了所有选项。

![](/img/in-post/2021-05-12-vim/467fff34d0b9e169.png)

单击**Next**按钮，设置如下选项。

- **选择安装类型（Select the type of install）**：典型（`Typical`），（启用**Create .bat files for command line use**选项之后，安装类型会自动变成`Custom`）。
- **不针对 Windows 行为重新映射按键（Do not remap keys for Windows behavior）**。
- **右键打开菜单，左键开始可视模式（Right button has a popup menu, left button starts visual mode）**。
- **安装路径（Destination Folder）**： `C:\Program Files (x86)\Vim`（或其他推荐的默认值）。

完成这些选项的设置之后，单击**Install**按钮，然后单击**Close**按钮，如下图所示。

![](/img/in-post/2021-05-12-vim/86aa07608337feb0.png)

安装结束时系统会询问是否查看 README 文件，单击**No**按钮即可(谁会现在就看手册呢？)，如下图所示。

![](/img/in-post/2021-05-12-vim/18067d8c1afa6ffc.png)

安装完成后，桌面上会出现一些新的图标，如下图所示。

![](/img/in-post/2021-05-12-vim/6f58994a2032992c.png)

双击此图标，Vim 就打开了！

### 1.3.5 　安装结果的验证和故障排除

不管在哪个平台上安装 Vim，最好先确认一下 Vim 的相关功能是否都已经启用。在命令行中，执行如下命令。

    $ vim --version

可以看到如下图所示的输出结果，它列出了一系列功能，每项功能前面都有加号（`+`）或减号（`-`）。

![](/img/in-post/2021-05-12-vim/16061205d68c0e79.png)

这里，加号（`+`）表示功能启用，减号（`-`）表示功能未启用。上图中的 Vim 支持 Python 2（`+python`），而不支持 Python 3（`-python3`）。要想解决这个问题，可以重新编译 Vim 并启用`+python3`，或者寻找一个支持 Python 3 的 Vim 发布版本。

> Vim 可以支持的所有功能列表参见`:help feature-list`。

在 Linux 系统中重新编译一个支持 Python 3 的 Vim 8.1，可以执行如下命令。

    $ git clone https://github.com/vim/vim.git
    $ cd vim/src
    $ ./configure --with-features=huge --enable-python3interp
    $ make
    $ sudo make install

> 传入`--with-features=huge`编译选项，是为了启用 Vim 的大部分功能。不过，`--with-features=huge`并不涉及语言的绑定，因此需要显式地启用 Python 3。

一般而言，如果读者感觉自己的 Vim 不像其他 Vim 那样运行（包括本文中描述的行为），那么有可能是因为缺失了某个 Vim 功能。这和读者的计算机操作系统以及特定的功能有关，因而安装过程可能或多或少会有不同。通过在网上搜索 Install Vim \<version> with + \<feature> on \<operating system>可能会有所帮助。

## 1.4 　命令行 Vim 和 gVim

通过前面介绍的指令，读者应该已经安装了两种 Vim——命令行 Vim 和 gVim。Windows 系统下的 gVim 如下图所示。

![](/img/in-post/2021-05-12-vim//0f44832bea190b4e.png)

gVim 实际上是为 Vim 绑定了一个图形用户界面（GUI），它具有更好的鼠标支持，还有更多上下文菜单。与终端模拟器相比，它还支持更多的配色，并具备一些现代图形用户界面应有的优质功能。在 Windows 系统中，读者可以通过打开桌面图标`gVim 8.1`来启动 gVim，而在 Linux 和 macOS 系统中，可通过如下命令行启动。

    $ gvim

Windows 用户可能会更青睐于 gVim。不过，由于本文更关注于文本编辑技巧中的效率方面，因此会避免涉及 gVim 菜单，虽然它们也很直观，但会影响用户专注于自己的工作流程。本文会更关注 Vim 的非图形界面版本，但这些内容同样适用于 gVim。这两个版本的 Vim 共享配置文件，相互之间切换使用完全没有问题。

总体来说，gVim 对新手更友好一些。

## 1.5 　通过`.vimrc`文件来配置 Vim

Vim 从一个名为`.vimrc`的文件中读取配置信息。Vim 安装好后就可以使用，但是有些选项会使程序编码更容易。

> 在类 UNIX 系统中，以句点.开头的文件为隐藏文件。为了看到这些文件，可以运行`ls -a`命令行。

在 Linux 和 macOS 系统中，`.vimrc`位于用户根目录中（完整路径为`/home/<用户名>/.vimrc`）。读者也可以打开一个命令行终端，并通过如下命令进入终端。

    $ echo $HOME

Windows 系统不允许文件名中出现句点，因此配置文件的名称为`_vimrc`，其路径通常为`C:\Users\<用户名>_vimrc`。读者也可以通过命令提示符中的如下命令找到其所在的目录。

    $ echo %USERPROFILE%

> 如果遇到了问题，可以打开 Vim，输入`:echo $MYVIMRC`，然后按`Enter`键。Vim 会显示它正在使用的`.vimrc`的路径。

找到操作系统存储 Vim 配置文件的目录，然后将准备好的配置文件放入其中。读者也可以从本文的官方 GitHub 仓库中找到本章涉及的`.vimrc`。下列代码为本章中使用的`.vimrc`文件的内容。

    syntax on                 " 支持语法高亮显示
    filetype plugin indent on " 启用根据文件类型自动缩进

    set autoindent            " 开始新行时处理缩进
    set expandtab             " 将制表符Tab展开为空格，这对于Python尤其有用
    set tabstop=4             " 要计算的空格数
    set shiftwidth=4          " 用于自动缩进的空格数

    set backspace=2           " 在多数终端上修正退格键Backspace的行为

    colorscheme murphy        " 修改配色

上面的代码中，双引号开头的内容为注释，会被 Vim 忽略。这些设置还是比较合理的，比如语法高亮和一致的缩进。它同时还解决了不同环境中退格键可能出现不同行为的问题。

> 当编写 Vim 配置文件时，可以先尝试相应的设置，然后再写到`.vimrc`文件中去。操作过程为先输入冒号，然后输入相应的命令，再按`Enter`键即可。比如`:set autoindent`（按`Enter`键执行）。如果想知道某种设置当前的值，可以在命令后面加上问号，比如执行`:set tabstop?`命令会显示出当前的`tabstop`的值。

此例中还修改了配色，让屏幕显示效果更好一些，但这并不是必需的。

> Vim 8 自带如下主题配色。
>
> `blue、darkblue、default、delek、desert、elflord、evening、industry、koehler、morning、murhpy、pablo、peachpuff、ron、shine、slate、torte、zellner。`读者可以尝试其中一种配色主题，方法是输入`:colorscheme<name>`，然后按`Enter`键；也可以在所有可用的配色主题之间循环切换，方法是输入`:colorscheme`，然后输入一个空格，并多次按 Tab 键。第 7 章中有更多关于 Vim 的配置和配色的介绍，届时读者可以拥有完全属于自己的 Vim。

## 1.6 　常用操作（特别是如何退出 Vim）

下图所示为一位 Vim 用户在 Twitter 上发布的帖子：我已经使用 Vim 两年了，主要原因是我不知道怎么退出来。

![](/img/in-post/2021-05-12-vim/9e9cb23ac8ab16ef.png)

现在，本文将介绍如何在不使用鼠标或菜单的情况下与 Vim 进行交互。编程本身是一种要求精力高度集中的任务，没有人会愿意一直单击菜单，让双手一直保持在键盘中心位置也有助于避免在鼠标和键盘之间频繁切换。

### 1.6.1 　打开文件

首先，请读者打开自己最喜欢的命令行终端（Linux 和 macOS 系统中是终端，Windows 系统中为 Cygwin），跟随下面的步骤来编写一个非常基础的 Python 程序。

先从一个简单的开平方根计算器开始，运行如下命令。

    $ vim animal_farm.py

> 如果读者使用 gVim，那么可以在**File**菜单中单击**Open**选项，然后打开一个文件。有时候，读者可能确实需要一个图形界面。

这会打开一个名为`animal_farm.py`的文件。如果此文件存在，则读者会看到它的内容；如果文件不存在，则得到一个空白界面，如下图所示。

![](/img/in-post/2021-05-12-vim/9f45dcbe38941706.png)

在上图中，Vim 的底部状态中显示了文件名，旁边还有`[New File]`字样，表示这是一个新文件。现在读者已经用 Vim 打开了第一个文件。

> Vim 的状态栏通常会包含很多有用的信息，它是 Vim 与用户交流的主要途径，因此需要保持对状态栏中的消息的关注。

如果之前已经打开过 Vim，则可以用如下命令加载一个文件（别忘了命令后面要按`Enter`键）。

    :e animal_farm.py

这有可能是读者在 Vim 中运行的第一条命令。输入冒号字符`:`表示进入命令行模式，在此模式下输入的文字会被 Vim 解析为命令。按`Enter`键可以结束命令，通过 Vim 命令可以执行很多复杂的操作，包括访问系统的命令行。命令`:e`表示编辑（edit）。

> Vim 的帮助文档中通常将`Enter`键记为回车（carriage return）的意思。

### 1.6.2 　修改文字

默认情况下，Vim 处于正常模式（normal mode），即每个键都对应于某个命令。输入命令`i`将使 Vim 进入插入模式（insert mode）。它会在底部的状态栏中显示-- INSERT --字样（如果读者使用的是 gVim，则光标由块状变为竖线状），如下图所示。

![](/img/in-post/2021-05-12-vim/122a0d305d8ab530.png)

插入模式下的行为和在其他无模式编辑器中相似。正常情况下，除添加新文本之外，本文不会花太多篇幅介绍插入模式。

> 本文中已经涉及了 3 种 Vim 模式：命令行模式、正常模式和插入模式。本文还会介绍很多模式，详情参见第 3 章。

现在输入如下图所示的代码，这就是之前提到的 Python 程序。本章将反复使用这几行代码。

![](/img/in-post/2021-05-12-vim/1d8c898039731c06.png)

按下 Esc 键可以返回到 Vim 的正常模式。这时，状态栏上的`-- INSERT --`字样消失，可以继续在 Vim 中输入命令。

> 上述代码并不是 Python 编程的最佳实践，这里只是用它来展示 Vim 的一些功能。

### 1.6.3 　保存和关闭文件

保存文件可执行`:w`命令。

> 注意，在输入命令后按下`Enter`键。

`:w`表示写（write）的意思。

> `:w`命令后面也可以接一个文件名，并另存为新文件。修改后的内容会保存到这个新文件中，当前文件也变成了这个新文件。尝试执行命令`:w animal_farm2.py`。

退出 Vim，并检查一下文件是否已经生成。命令`:q`表示退出（quit）的意思。也可以将写和退出这两个命令组合为`:wq`，表示先保存后退出。

如果修改了文件，但是不想保存而直接退出 Vim，可以用命令`:q!`强制退出 Vim。命令后面的感叹号表示强制执行。

> Vim 的许多命令都有长短两个版本。比如`:e`、`:w`和`:q`分别是`:edit`、`:write`和`:quit`的短版本。在 Vim 手册中，命令的可选部分通常置于一对中括号中，比如`:w[rite]`和`:e[dit]`。

退出 Vim 之后又回到了系统的命令行，可以检查一下当前目录中的内容是否发生了变化，如下列命令所示。

    $ ls
    $ python3 animal_farm.py
    $ python3 animal_farm.py cat dog sheep

> 在 UNIX 中，ls 表示列出当前目录的内容。`python3 animal_farm.py`表示用 Python 3 解释器来执行这个脚本。`python3 animal_farm.py cat dog sheep`表示执行此脚本，并传入（`cat, dog, sheep`）这 3 个参数。

下图中显示了这 3 条命令的输出结果。

![](/img/in-post/2021-05-12-vim/219b67adbf8fd261.png)

### 1.6.4 　关于交换文件

默认情况下，Vim 用交换文件跟踪文件的变化情况。当用户编辑文件的时候，Vim 会自动产生交换文件。交换文件的作用是恢复文件内容，以防止用户的 Vim、SSH 会话或系统崩溃。一旦出现上述问题，或者由于其他失误意外地退出 Vim，再次用 Vim 打开同一个文件时，就会看到如下图所示的画面。

![](/img/in-post/2021-05-12-vim/3e0ee5c0892b15f2.png)

这时，可以输入`r`从交换文件中恢复文件，或者输入`d`直接忽略交换文件。如果读者决定从交换文件中恢复，为了避免下次打开此文件时再次出现这个提示，可以输入`d`删除交换文件。

默认情况下，Vim 会在原始文件所在的目录下生成类似于`<filename>.swp`或`.<filename>.swp`的文件。为避免这些交换文件污染文件系统，可以修改这个默认行为，使 Vim 将所有交换文件都统一存放在同一个目录中。要实现这个设置，可以在`.vimrc`文件中加入如下内容。

    set directory=$HOME/.vim/swap//

> 如果使用 Windows 系统，设置命令为`set directory= %USERDATA%.vim\swap//`（注意最后两个斜线的方向）。

或者，也可以选择完全禁止交换文件，在`.vimrc`中加入`set noswapfile`即可。

### 1.6.5 　随意移动：与编辑器对话

Vim 中的光标移动方式比大部分传统编辑器都要更便捷高效一些。本节只介绍基本的操作。

在 Vim 中可以用方向键或字母`h`、`j`、`k`、`l`来逐个字符地移动光标，这是效率最低，但也是最精确的移动方式，如下表所示。

| 按键  |   替代键   |     行为     |
| :---: | :--------: | :----------: |
|  `h`  | 向左箭头键 | 向左移动光标 |
|  `j`  | 向下箭头键 | 向下移动光标 |
|  `k`  | 向上箭头键 | 向上移动光标 |
|  `l`  | 向右箭头键 | 向右移动光标 |

这几个字母不是随意选的，从下图中可以发现它们在方位上的对应关系。

![](/img/in-post/2021-05-12-vim/d605aa5c2e1eae1d.png)

Vi（Vim 的前身）是从 ADM-3A 终端机上创造出来的，如下图所示，这台机器并没有方向键，因而`h`、`j`、`k`、`l`被选择用来表示方向。

![](/img/in-post/2021-05-12-vim/6caff570fe5b2c4b.png)

习惯用`hjkl`来移动光标有很多好处：双手就可以集中于键盘中央，从而使用户更专注于工作流程。此外，许多应用也将`hjkl`用作方向键，也许数目多到让人惊讶。

现在，读者可能已经倾向于多次敲击这些方向键到达目标位置了，但是还有更好的方式。在每一个命令之前可以加一个数字，表示重复这条命令的次数。比如，敲击`5j`会让光标下移 5 次，而`14l`会让光标右移 14 个字符。这条规则适用于本文提到的大多数命令。

但是，精确计算到底要移动多少次往往是比较麻烦的（没人会愿意这么做），因此，还有一种方式是逐个词语移动光标。可以用`w`移动到下一个单词开头，用`e`移动到最近的单词的结尾。如果想反向移动到单词的开头，可以按`b`键。

在 Vim 中还可以使用这些命令的大写版本，表示将除空格外的所有字符视为单词的一部分！这两套命令可让读者以两种不同的方式浏览文本。

> Vim 中有两种单词对象：狭义单词（word）和广义单词（WORD）。在 Vim 的世界里，狭义单词指的是由空白字符（比如空格、制表符或换行符）分隔的字母、数字和下划线组成的序列，广义单词则是由空格分隔的任何非空字符组成的序列。

比如前面的示例中的某一行代码，如下图所示。

![](/img/in-post/2021-05-12-vim/4a1e336c3ccfbf26.png)

> 注意光标位置，它覆盖了`add_animal`的首字符。

输入`w`，光标会停在`add_animal`的首字符上，而`W`则会跳到`animal`的首字符上。大写的`W`、`E`和`B`将以空格分隔的非空字符序列视为单词，如下表所示。

| 按键  |              行为              |
| :---: | :----------------------------: |
|  `w`  |        逐个狭义单词移动        |
|  `e`  | 向前移动直到最近狭义单词的结尾 |
|  `W`  |        逐个广义单词移动        |
|  `E`  | 向前移动直到最近广义单词的结尾 |
|  `b`  |     向后移动到狭义单词开头     |
|  `B`  |     向后移动到广义单词开头     |

下表则为每个命令的具体表现。

| 按键  |                     初始光标位置                      |                                                 光标最终位置                                                 |
| :---: | :---------------------------------------------------: | :----------------------------------------------------------------------------------------------------------: |
|  `w`  | ![](/img/in-post/2021-05-12-vim/78e4c1c170b2436e.png) |                            ![](/img/in-post/2021-05-12-vim/26f3f97825224943.png)                             |
|  `e`  | ![](/img/in-post/2021-05-12-vim/23f21d0db76312ec.png) | ![](https://img30.360buyimg.com/ebookadmin/jfs/t1/93762/1/13064/1061/5e54e249Efc50843d/fcc0ac6f51e47c5c.png) |
|  `b`  | ![](/img/in-post/2021-05-12-vim/c00795a5f911ea32.png) |                            ![](/img/in-post/2021-05-12-vim/ac0d9f44367c4c80.png)                             |
|  `W`  | ![](/img/in-post/2021-05-12-vim/0e1172cec7a714ea.png) |                            ![](/img/in-post/2021-05-12-vim/78f4f0cc93a34a3c.png)                             |
|  `E`  | ![](/img/in-post/2021-05-12-vim/4ab9098695b07a45.png) |                            ![](/img/in-post/2021-05-12-vim/8c0c5bcfafb7b231.png)                             |
|  `B`  | ![](/img/in-post/2021-05-12-vim/098d8811bb825e00.png) |                            ![](/img/in-post/2021-05-12-vim/63a6d99d000f1c56.png)                             |

将这些命令与之前的方向命令结合起来，可以用更少的输入实现更快的移动。

另外，按照段落移动也是很有用的。任意两个空行之间的文字被视为段落，这也意味着每个代码块可视为一个段落，如下图中所示。

![](/img/in-post/2021-05-12-vim/76e1c579fd52c6fb.png)

函数`add_animal`和`main`为两个不同的段落。在段落间向前移动的命令是结束大括号`}`，向后移动的命令是开始大括号`{`，如下表所示。

| 命令  |       行为       |
| :---: | :--------------: |
|  `{`  | 向后移动一个段落 |
|  `}`  | 向前移动一个段落 |

在这些命令前面也可以加数字，这样，即使需要跳过多个段落，也可以一步到位。

移动光标还有其他方式，上述只是一些重要的基础知识。第 2 章中会介绍更复杂的浏览方式。

### 1.6.6 　插入模式下的简单编辑

使用 Vim 的时候，通常希望在插入模式下花费尽可能少的时间（除非只负责写而不编辑）。因为大部分文本操作涉及编辑，所以本节将关注于这一部分。

前面已经提到过，进入插入模式的命令为`i`。除此之外，还有其他方式可以进入插入模式。很多时候，需要对一部分文字进行替换，实现这个功能的方式是**修改命令**`c`。通过**修改命令**读者可以在删除一部分文字后立刻进入插入模式。**修改命令**是一个复合命令，即它后面必须指定其他命令，用于告诉 Vim 修改哪一部分。读者可以将**修改命令**与前面介绍过的任何移动命令组合起来使用，可参考下表中的示例。

|          命令           |                        执行前                         |                        执行后                         |
| :---------------------: | :---------------------------------------------------: | :---------------------------------------------------: |
|          `cw`           | ![](/img/in-post/2021-05-12-vim/0bc8a8a41501f0f2.png) | ![](/img/in-post/2021-05-12-vim/70ad7f5bc76915f9.png) |
| `c3e`（逗号视为一个词） | ![](/img/in-post/2021-05-12-vim/28f757ad110d05b6.png) | ![](/img/in-post/2021-05-12-vim/248b91d89520fef9.png) |
|          `cb`           | ![](/img/in-post/2021-05-12-vim/7e9464f721517aef.png) | ![](/img/in-post/2021-05-12-vim/5445472be0c815d4.png) |
|          `c4l`          | ![](/img/in-post/2021-05-12-vim/f501654aed005289.png) | ![](/img/in-post/2021-05-12-vim/ab0c91768967c98b.png) |
|          `cW`           | ![](/img/in-post/2021-05-12-vim/f88430e6b623d551.png) | ![](/img/in-post/2021-05-12-vim/6fd3b9b9fc4bbe7d.png) |

> 其中有一个奇怪的例外，`cw`和`ce`的行为类似，这是 Vim 的前身 Vi 的历史遗留问题。

在掌握了更复杂的移动命令之后，也可以将它们与修改命令组合起来，实现快速的无缝编辑。本文后续还会介绍一些 Vim 插件，它们会重新实现修改命令，从而支持更强大的编辑功能，比如修改括号里的文字或直接替换引号类型。

> 所有这些例子都遵循`<命令> <数字> <移动或一个文本对象>`这样的语法结构，可以将数字放在命令之前或之后。

若想将`farm = add_animal(farm, animal)`修改为`farm = add_animal (farm, creature)`，可以依次执行下表中列出的命令。

|                        代码行                         |                     行为                     |
| :---------------------------------------------------: | :------------------------------------------: |
| ![(/img/in-post/2021-05-12-vim/d7cc0c65d023b315.png)  |                将光标置于行首                |
| ![](/img/in-post/2021-05-12-vim/019ee6c1a95e5280.png) | 按`3W`让光标跳过广义单词到达`animal`的首字母 |
| ![](/img/in-post/2021-05-12-vim/72dae421460c9e96.png) | 按`cw`删除单词`animal`，然后立刻进入插入模式 |
| ![](/img/in-post/2021-05-12-vim/1a3b1f0c58e875ca.png) |                输入`creature`                |
| ![](/img/in-post/2021-05-12-vim/f0f5149752e60307.png) |            按 Esc 键回到正常模式             |

不过，有时候用户可能只想删除文字，而不想插入任何东西，命令`d`可以实现这个功能。它表示删除（delete）的意思，其行为类似于`c`，只不过这时候的`w`和`e`的行为会标准得多，如下表所示。

|          命令           |                       执行之前                        |                       执行之后                        |
| :---------------------: | :---------------------------------------------------: | :---------------------------------------------------: |
|          `dw`           | ![](/img/in-post/2021-05-12-vim/e195a0defa0fc1a1.png) | ![](/img/in-post/2021-05-12-vim/18feeabe57afba1e.png) |
| `d3e`（逗号算一个单词） | ![](/img/in-post/2021-05-12-vim/a06fab93e4b9bd5d.png) | ![](/img/in-post/2021-05-12-vim/99c72d293e88fb62.png) |
|          `db`           | ![](/img/in-post/2021-05-12-vim/7567f702b3766c54.png) | ![](/img/in-post/2021-05-12-vim/ea8f661f276f598b.png) |
|          `d4l`          | ![](/img/in-post/2021-05-12-vim/5b2265031461704c.png) | ![](/img/in-post/2021-05-12-vim/34d4dd2094faf01d.png) |
|          `dW`           | ![](/img/in-post/2021-05-12-vim/ddd595c544ea88ed.png) | ![](/img/in-post/2021-05-12-vim/5e842b7c9aa59209.png) |

还有两个更好的快捷命令用于修改或删除一整行，如下表所示。

| 命令  |                               行为                               |
| :---: | :--------------------------------------------------------------: |
| `cc`  | 清除整行，然后进入插入模式。保持当前的缩进水平，这在编程时很有用 |
| `dd`  |                             删除整行                             |

比如，对于下1图中的代码片断，通过`dd`命令，可以移除整行，并得到下2图中的结果。

![](/img/in-post/2021-05-12-vim/b16e3cc9549e2be8.png)

![](/img/in-post/2021-05-12-vim/e79ee4a5a7927d5d.png)

但如果使用`cc`命令删除该行，则会保留原来的缩进并进入插入模式，如下图所示。

![](/img/in-post/2021-05-12-vim/7eb6c589ce060bfe.png)

> 如果读者在选择正确的光标移动命令时存在困难，也可以用可视（visual）模式来选择待修改的文本。按`v`键可进入可视模式，然后通过常用的光标移动命令调整选择的文本。一旦选择完毕，就可以运行相应的命令（如用`c`键来修改或用`d`键来删除）。

### 1.6.7 　持久性的撤销和重复

和任何其他编辑器一样，Vim 也记录了每一步操作。按`u`键可以撤销最后一次操作，而`Ctrl + r`组合键则可以重做此操作。

> 欲了解关于 Vim 撤销树的更多内容（Vim 的撤销历史记录不是线性的！），以及如何浏览这些历史记录，请参考第 4 章。

Vim 还支持在不同会话之间持久保存撤销历史，从而允许撤销几天前的操作。

可以通过在`.vimrc`中进行如下设置来启用持久性撤销。

    set undofile

不过，这会在系统中为每个被编辑过的文件保留一个撤销历史记录文件，显得有些混乱。也可以将这些文件保存在同一个目录中，配置如下所示。

    " 为所有文件设置持久性撤销
    set undofile
    if !isdirectory("$HOME/.vim/undodir")
      call mkdir("$HOME/.vim/undodir", "p")
    endif
    set undodir="$HOME/.vim/undodir"

> 对于 Windows 操作系统，将上述设置中的目录换成`%USERPROFILE%_vim`。需要注意，Windows 下的配置文件是`_vimrc`，而不是`.vimrc`。

### 1.6.8 　通过`:help`阅读 Vim 手册

Vim 提供了一个学习工具`:help`命令，其界面如下图所示。

![](/img/in-post/2021-05-12-vim/e7ae3d32f745d8af.png)

Vim 手册中附带了大量的资源和教程。通过翻页键（PageUp 和 PageDown）可以浏览手册的内容（注意，`Ctrl + b`组合键和`Ctrl + f`组合键也能起到翻页的效果），信息极其丰富。

如果读者使用 Vim 时遇到问题，或者希望深入了解某个命令，可尝试使用`:help`（其缩略版为`:h`）来搜索这个命令。比如，读者可以搜索一下`cc`。

    :h cc

下图中的帮助信息显示了这条命令的运行方式，以及不同选项和设置是如何影响它的（如 autoindent 设置可保持缩进）。

![](/img/in-post/2021-05-12-vim/5ac787e825abfbc7.png)

`:help`命令可用于浏览所有这些帮助文件。在阅读帮助文件时会发现，某些词是高亮显示的。它们是标签，即可用于`:help`命令的关键字。不过，不是每个标签名都很直观。如果想知道如何在 Vim 中搜索一个字符串，用户可能会尝试使用如下命令。

    :h search

然而，输入这条命令后进入了表达式评估（expression evaluation）的页面，这并不是读者想要的，如下图所示。

![](/img/in-post/2021-05-12-vim/83034cc0c6555d52.png)

为找到正确的词条，输入`:h search`（先不要按`Enter`键），然后按`Ctrl + D`组合键。这时会得到一个包含字符`search`的标签列表。其中一项为`search-commands`，这正是读者需要的。接下来继续补充命令行。

    :h search-commands

得到如下图所示的帮助页面，这正是预期的结果。

![](/img/in-post/2021-05-12-vim/22dcf55dc2726338.png)

> 关于搜索功能，读者可以在帮助页面（或在 Vim 中打开的任何文件）中输入“`/关键字`”进行正向搜索，或输入“`?关键字`”进行反向搜索。欲了解更多关于搜索操作的内容，请参考第 2 章。

任何时候都不要忘记使用 Vim 的帮助系统，特别是有疑问或希望更好地理解 Vim 的行为时。

## 1.7 　小结

原来的 Vi 版本是针对远程终端开发出来的，那时的带宽和网速都有限。但正是这些限制使 Vi 的文本编辑流程变得高效而专业，从而演变为如今的 Vim（改进版 Vi，Vi Improved）的核心。

本章介绍了如何在主流平台上安装和更新 Vim，以及它的图形界面版本 gVim（介绍了太多方法，有些可能根本就不需要）。

然后介绍了如何通过修改`.vimrc`文件来配置 Vim，这个过程在今后可能会反复进行，因为读者需要根据自己的需求定制这个编辑器。

另外，还介绍了处理文件、在 Vim 中移动光标和修改内容等基本操作。Vim 中的文本对象的概念（字母、单词和段落）和复合命令（如`d2w`会删除两个单词）可以帮助读者做出精确的文本操作。

如果读者能从本章中学会一件事，那一定是`:help`。Vim 内置的帮助系统极其详细，它几乎可以回答所有关于 Vim 的问题。
